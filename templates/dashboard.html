<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebhookÁÆ°ÁêÜÁ≥ªÁªü - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
        }
        
        .nav-links {
            display: flex;
            gap: 1rem;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        .nav-links a:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .controls {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .messages-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .messages-header {
            background: #f8f9fa;
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            font-weight: bold;
        }
        
        .message-item {
            border-bottom: 1px solid #e9ecef;
            padding: 1rem;
            transition: background-color 0.3s;
        }
        
        .message-item:hover {
            background-color: #f8f9fa;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .message-id {
            font-weight: bold;
            color: #667eea;
        }
        
        .message-timestamp {
            color: #666;
            font-size: 0.9rem;
        }
        
        .message-source {
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
        }
        
        .message-content {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .json-viewer {
            background: #263238;
            color: #ffffff;
            padding: 1rem;
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .json-key {
            color: #82b1ff;
        }
        
        .json-string {
            color: #c3e88d;
        }
        
        .json-number {
            color: #f78c6c;
        }
        
        .json-boolean {
            color: #ff9cac;
        }
        
        .json-null {
            color: #546e7a;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 2rem 0;
            gap: 0.5rem;
        }
        
        .pagination a, .pagination span {
            padding: 0.5rem 1rem;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            text-decoration: none;
            color: #667eea;
            background: white;
            transition: all 0.3s;
        }
        
        .pagination a:hover {
            background: #667eea;
            color: white;
        }
        
        .pagination .current {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        
        .pagination .disabled {
            color: #ccc;
            pointer-events: none;
        }
        
        .filter-controls {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: #667eea;
        }
        
        .real-time-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 999;
            display: none;
            transition: all 0.3s ease;
        }
        
        .real-time-indicator.connected {
            display: block;
            background: #4CAF50;
        }
        
        .real-time-indicator:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .real-time-indicator.connected {
            display: block;
            background: #4CAF50;
        }
        
        .real-time-indicator.disconnected {
            display: block;
            background: #f44336;
        }
        
        .new-message-notification {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: #2196F3;
            color: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1001;
            max-width: 300px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .message-item.new-message {
            animation: highlightNew 2s ease-out;
        }
        
        @keyframes highlightNew {
            0% {
                background-color: #e3f2fd;
                border-left: 4px solid #2196F3;
            }
            100% {
                background-color: white;
                border-left: none;
            }
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        .alert {
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <!-- ÂÆûÊó∂ËøûÊé•Áä∂ÊÄÅÊåáÁ§∫Âô® -->
    <div id="real-time-indicator" class="real-time-indicator">
        <span id="status-text">üîó ÂÆûÊó∂ËøûÊé•‰∏≠...</span>
    </div>
    
    <!-- Êñ∞Ê∂àÊÅØÈÄöÁü• -->
    <div id="message-notification" class="new-message-notification" style="display: none;">
        <div id="notification-content"></div>
    </div>
    
    <div class="header">
        <h1>üìä Webhook Dashboard</h1>
        <div class="nav-links">
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('settings') }}">ËÆæÁΩÆ</a>
            <a href="{{ url_for('logout') }}">ÁôªÂá∫</a>
        </div>
    </div>
    
    <div class="container" 
         data-current-page="{{ pagination.current_page }}" 
         data-include-archived="{{ 'true' if include_archived else 'false' }}">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ message_count }}</div>
                <div class="stat-label">ÊÄªÊ∂àÊÅØÊï∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="recent-count">
                    {% set recent_count = messages|selectattr('timestamp')|list|length %}
                    {{ recent_count if recent_count <= 24 else 24 }}
                </div>
                <div class="stat-label">ÊúÄËøëÊ∂àÊÅØ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ '/webhook' }}</div>
                <div class="stat-label">WebhookÁ´ØÁÇπ</div>
            </div>
        </div>
        
        <div class="filter-controls">
            <div>
                üìÑ <strong>Ê∂àÊÅØËøáÊª§:</strong>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="include-archived" {{ 'checked' if include_archived else '' }}>
                <span class="toggle-slider"></span>
            </label>
            <span>ÂåÖÂê´ÂΩíÊ°£Ê∂àÊÅØ</span>
            
            <div style="margin-left: auto;">
                <strong>ÂΩìÂâçÊ¥ªË∑É:</strong> {{ message_count }} Êù°
                <span data-archived-info>
                    {% if archived_files %}
                        | <strong>ÂΩíÊ°£Êñá‰ª∂:</strong> {{ archived_files|length }} ‰∏™
                    {% endif %}
                </span>
            </div>
        </div>
        
        <div class="controls">
            <div>
                <button class="btn btn-primary" onclick="refreshMessages()">üîÑ Âà∑Êñ∞</button>
                <button class="btn btn-primary" onclick="autoRefreshToggle()" id="auto-refresh-btn" style="background-color: #e74c3c;">‚èπÔ∏è ÂÅúÊ≠¢Âà∑Êñ∞</button>
            </div>
            <button class="btn btn-danger" onclick="clearMessages()">üóëÔ∏è Ê∏ÖÁ©∫Ê∂àÊÅØ</button>
        </div>
        
        <div class="messages-container">
            <div class="messages-header">
                üì® Êé•Êî∂ÁöÑWebhookÊ∂àÊÅØ
            </div>
            
            <div id="messages-list">
                {% if messages %}
                    {% for message in messages %}
                    <div class="message-item">
                        <div class="message-header">
                            <span class="message-id">#{{ message.id }}</span>
                            <span class="message-timestamp">{{ message.timestamp }}</span>
                            <span class="message-source">{{ message.source_ip }}</span>
                        </div>
                        
                        {% if message.error %}
                            <div style="color: #e74c3c; font-weight: bold; margin-bottom: 0.5rem;">
                                ‚ùå ÈîôËØØ: {{ message.error }}
                            </div>
                        {% endif %}
                        
                        <div class="message-content">
                            {% if message.error %}
                                <strong>ÈîôËØØ‰ø°ÊÅØ:</strong><br>
                                <span style="color: #e74c3c;">{{ message.error }}</span><br><br>
                                <strong>ÂéüÂßãÊï∞ÊçÆ:</strong><br>
                                <div class="json-viewer">{{ message.data }}</div>
                            {% else %}
                                <strong>Data:</strong><br>
                                {% if message.data %}
                                    <div class="json-viewer" data-json='{{ message.data | tojson }}'></div>
                                {% else %}
                                    <div class="json-viewer">Êó†Êï∞ÊçÆ</div>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i>üì≠</i>
                        <h3>ÊöÇÊó†Ê∂àÊÅØ</h3>
                        <p>WebhookÁ´ØÁÇπ: <code>{{ request.url_root }}webhook</code></p>
                        <p>ÂèëÈÄÅPOSTËØ∑Ê±ÇÂà∞‰∏äËø∞Âú∞ÂùÄÊù•ÊµãËØï</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- ÂàÜÈ°µÂØºËà™ -->
        {% if pagination.total_pages > 1 %}
        <div class="pagination">
            {% if pagination.has_prev %}
                <a href="?page=1{{ '&archived=true' if include_archived else '' }}">¬´ È¶ñÈ°µ</a>
                <a href="?page={{ pagination.current_page - 1 }}{{ '&archived=true' if include_archived else '' }}">‚Äπ ‰∏äÈ°µ</a>
            {% else %}
                <span class="disabled">¬´ È¶ñÈ°µ</span>
                <span class="disabled">‚Äπ ‰∏äÈ°µ</span>
            {% endif %}
            
            {% for page_num in range(1, pagination.total_pages + 1) %}
                {% if page_num == pagination.current_page %}
                    <span class="current">{{ page_num }}</span>
                {% elif page_num <= 3 or page_num > pagination.total_pages - 3 or (page_num >= pagination.current_page - 2 and page_num <= pagination.current_page + 2) %}
                    <a href="?page={{ page_num }}{{ '&archived=true' if include_archived else '' }}">{{ page_num }}</a>
                {% elif page_num == 4 or page_num == pagination.total_pages - 3 %}
                    <span>...</span>
                {% endif %}
            {% endfor %}
            
            {% if pagination.has_next %}
                <a href="?page={{ pagination.current_page + 1 }}{{ '&archived=true' if include_archived else '' }}">‰∏ãÈ°µ ‚Ä∫</a>
                <a href="?page={{ pagination.total_pages }}{{ '&archived=true' if include_archived else '' }}">Êú´È°µ ¬ª</a>
            {% else %}
                <span class="disabled">‰∏ãÈ°µ ‚Ä∫</span>
                <span class="disabled">Êú´È°µ ¬ª</span>
            {% endif %}
        </div>
        
        <div style="text-align: center; color: #666; margin: 1rem 0;">
            ÊòæÁ§∫ {{ (pagination.current_page - 1) * pagination.page_size + 1 }} - 
            {{ [pagination.current_page * pagination.page_size, pagination.total_messages] | min }} 
            ÂÖ± {{ pagination.total_messages }} Êù°Ê∂àÊÅØ
        </div>
        {% endif %}
    </div>
    
    <script>
        // Webhook Dashboard JavaScriptÂäüËÉΩ
        let autoRefreshInterval = null;
        let isAutoRefresh = true;  // ÈªòËÆ§ÂºÄÂêØËá™Âä®Âà∑Êñ∞
        let currentPage = parseInt(document.querySelector('.container').dataset.currentPage) || 1;
        let includeArchived = document.querySelector('.container').dataset.includeArchived === 'true';
        let eventSource = null;
        let realTimeEnabled = false;
        
        // JSONËØ≠Ê≥ïÈ´ò‰∫ÆÂáΩÊï∞
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
        
        // ÂÆûÊó∂Ê∂àÊÅØÊé®ÈÄÅÂäüËÉΩ
        function initRealTimeConnection() {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource('/api/stream');
            
            eventSource.onopen = function() {
                console.log('ÂÆûÊó∂ËøûÊé•Â∑≤Âª∫Á´ã');
                updateConnectionStatus('connected');
                realTimeEnabled = true;
            };
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'new_message') {
                        handleNewMessage(data.data);
                    } else if (data.type === 'heartbeat') {
                        // ÂøÉË∑≥‰øùÊåÅËøûÊé•
                        console.log('ÂøÉË∑≥');
                    }
                } catch (e) {
                    console.error('Ëß£ÊûêÂÆûÊó∂Ê∂àÊÅØÂ§±Ë¥•:', e);
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('ÂÆûÊó∂ËøûÊé•ÈîôËØØ:', event);
                updateConnectionStatus('disconnected');
                realTimeEnabled = false;
                
                // 5ÁßíÂêéÈáçËøû
                setTimeout(initRealTimeConnection, 5000);
            };
        }
        
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('real-time-indicator');
            const statusText = document.getElementById('status-text');
            
            indicator.className = 'real-time-indicator ' + status;
            
            if (status === 'connected') {
                statusText.textContent = 'üîó ÂÆûÊó∂ËøûÊé•Ê≠£Â∏∏';
            } else {
                statusText.textContent = '‚ö†Ô∏è ËøûÊé•‰∏≠Êñ≠';
            }
        }
        
        function handleNewMessage(message) {
            console.log('Êî∂Âà∞Êñ∞Ê∂àÊÅØ:', message);
            
            // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
            updateMessageStats();
            
            // Âè™Âú®Á¨¨‰∏ÄÈ°µ‰∏îÈùûÂΩíÊ°£Ê®°Âºè‰∏ãÊòæÁ§∫Êñ∞Ê∂àÊÅØ
            if (currentPage === 1 && !includeArchived) {
                // ÊòæÁ§∫ÈÄöÁü•
                showNewMessageNotification(message);
                
                // Âú®ÂàóË°®È°∂ÈÉ®Ê∑ªÂä†Êñ∞Ê∂àÊÅØ
                addNewMessageToList(message);
            } else {
                // ÂÖ∂‰ªñÈ°µÈù¢Âè™ÊòæÁ§∫ÈÄöÁü•
                showNewMessageNotification(message);
            }
        }
        
        function updateMessageStats() {
            // Êõ¥Êñ∞Ê∂àÊÅØÁªüËÆ°Êï∞ÊçÆ
            // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÁªüËÆ°Êï∞ÊçÆ
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    // Êõ¥Êñ∞ÊÄªÊ∂àÊÅØÊï∞
                    const totalCountElement = document.querySelector('.stat-number');
                    if (totalCountElement && data.total_messages !== undefined) {
                        totalCountElement.textContent = data.total_messages;
                        
                        // Ê∑ªÂä†Êõ¥Êñ∞Âä®ÁîªÊïàÊûú
                        totalCountElement.style.transform = 'scale(1.1)';
                        totalCountElement.style.color = '#4CAF50';
                        
                        setTimeout(() => {
                            totalCountElement.style.transform = 'scale(1)';
                            totalCountElement.style.color = '#667eea';
                        }, 300);
                    }
                    
                    // Êõ¥Êñ∞ÊúÄËøëÊ∂àÊÅØÊï∞
                    const recentCountElement = document.getElementById('recent-count');
                    if (recentCountElement && data.recent_messages !== undefined) {
                        recentCountElement.textContent = data.recent_messages;
                    }
                    
                    // Êõ¥Êñ∞ÂΩíÊ°£Êñá‰ª∂Êï∞
                    if (data.archived_files !== undefined) {
                        updateArchivedInfo(data.archived_files);
                    }
                })
                .catch(error => {
                    console.error('Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', error);
                });
        }
        
        function updateArchivedInfo(archivedCount) {
            // Êõ¥Êñ∞ÂΩíÊ°£‰ø°ÊÅØÊòæÁ§∫
            const filterControls = document.querySelector('.filter-controls');
            if (filterControls) {
                const archivedInfo = filterControls.querySelector('[data-archived-info]');
                if (archivedInfo) {
                    if (archivedCount > 0) {
                        archivedInfo.innerHTML = `| <strong>ÂΩíÊ°£Êñá‰ª∂:</strong> ${archivedCount} ‰∏™`;
                        archivedInfo.style.display = 'inline';
                    } else {
                        archivedInfo.style.display = 'none';
                    }
                }
            }
        }
        
        function showNewMessageNotification(message) {
            const notification = document.getElementById('message-notification');
            const content = document.getElementById('notification-content');
            
            let messagePreview = '';
            if (message.error) {
                messagePreview = `ÈîôËØØ: ${message.error}`;
            } else if (message.data && typeof message.data === 'object') {
                messagePreview = `‰∫ã‰ª∂: ${message.data.event || 'Êú™Áü•'}`;
            } else {
                messagePreview = 'Êñ∞Ê∂àÊÅØ';
            }
            
            content.innerHTML = `
                <strong>üì® Êñ∞WebhookÊ∂àÊÅØ</strong><br>
                <small>${message.timestamp}</small><br>
                ${messagePreview}
            `;
            
            notification.style.display = 'block';
            
            // 3ÁßíÂêéËá™Âä®ÈöêËóè
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function addNewMessageToList(message) {
            const messagesList = document.getElementById('messages-list');
            const emptyState = messagesList.querySelector('.empty-state');
            
            // Â¶ÇÊûúÊòØÁ©∫Áä∂ÊÄÅÔºåÂÖàÊ∏ÖÈô§
            if (emptyState) {
                messagesList.innerHTML = '';
            }
            
            // ÂàõÂª∫Êñ∞Ê∂àÊÅØÂÖÉÁ¥†
            const messageHtml = createMessageElement(message);
            
            // ÊèíÂÖ•Âà∞ÂàóË°®È°∂ÈÉ®
            messagesList.insertAdjacentHTML('afterbegin', messageHtml);
            
            // ÁªôÊñ∞Ê∂àÊÅØÊ∑ªÂä†È´ò‰∫ÆÊïàÊûú
            const newItem = messagesList.querySelector('.message-item');
            newItem.classList.add('new-message');
            
            // ÈôêÂà∂ÊòæÁ§∫Êï∞ÈáèÔºåÁßªÈô§Â§ö‰ΩôÁöÑÊ∂àÊÅØ
            const items = messagesList.querySelectorAll('.message-item');
            if (items.length > 20) {
                items[items.length - 1].remove();
            }
        }
        
        function createMessageElement(message) {
            let contentHtml = '';
            
            if (message.error) {
                contentHtml = `
                    <strong>ÈîôËØØ‰ø°ÊÅØ:</strong><br>
                    <span style="color: #e74c3c;">${message.error}</span><br><br>
                    <strong>ÂéüÂßãÊï∞ÊçÆ:</strong><br>
                    <div class="json-viewer">${message.data}</div>
                `;
            } else {
                const jsonData = message.data ? JSON.stringify(message.data, null, 2) : 'Êó†Êï∞ÊçÆ';
                contentHtml = `
                    <strong>Data:</strong><br>
                    <div class="json-viewer">${message.data ? syntaxHighlight(jsonData) : 'Êó†Êï∞ÊçÆ'}</div>
                `;
            }
            
            return `
                <div class="message-item">
                    <div class="message-header">
                        <span class="message-id">#${message.id}</span>
                        <span class="message-timestamp">${message.timestamp}</span>
                        <span class="message-source">${message.source_ip}</span>
                    </div>
                    
                    ${message.error ? `
                        <div style="color: #e74c3c; font-weight: bold; margin-bottom: 0.5rem;">
                            ‚ùå ÈîôËØØ: ${message.error}
                        </div>
                    ` : ''}
                    
                    <div class="message-content">
                        ${contentHtml}
                    </div>
                </div>
            `;
        }
        
        // Âà∑Êñ∞Ê∂àÊÅØ
        function refreshMessages() {
            const params = new URLSearchParams();
            params.set('page', currentPage);
            if (includeArchived) {
                params.set('archived', 'true');
            }
            
            fetch('/api/messages?' + params.toString())
                .then(response => response.json())
                .then(data => {
                    updateMessagesDisplay(data.messages);
                    updatePagination(data.pagination);
                    // ÂêåÊó∂Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
                    updateMessageStats();
                })
                .catch(error => {
                    console.error('Âà∑Êñ∞Â§±Ë¥•:', error);
                    alert('Âà∑Êñ∞Â§±Ë¥•: ' + error.message);
                });
        }
        
        // Êõ¥Êñ∞Ê∂àÊÅØÊòæÁ§∫
        function updateMessagesDisplay(messages) {
            const messagesList = document.getElementById('messages-list');
            
            if (messages.length === 0) {
                messagesList.innerHTML = `
                    <div class="empty-state">
                        <i>üì≠</i>
                        <h3>ÊöÇÊó†Ê∂àÊÅØ</h3>
                        <p>WebhookÁ´ØÁÇπ: <code>${window.location.origin}/webhook</code></p>
                        <p>ÂèëÈÄÅPOSTËØ∑Ê±ÇÂà∞‰∏äËø∞Âú∞ÂùÄÊù•ÊµãËØï</p>
                    </div>
                `;
                return;
            }
            
            messagesList.innerHTML = messages.map(message => {
                let contentHtml = '';
                
                if (message.error) {
                    contentHtml = `
                        <strong>ÈîôËØØ‰ø°ÊÅØ:</strong><br>
                        <span style="color: #e74c3c;">${message.error}</span><br><br>
                        <strong>ÂéüÂßãÊï∞ÊçÆ:</strong><br>
                        <div class="json-viewer">${message.data}</div>
                    `;
                } else {
                    const jsonData = message.data ? JSON.stringify(message.data, null, 2) : 'Êó†Êï∞ÊçÆ';
                    contentHtml = `
                        <strong>Data:</strong><br>
                        <div class="json-viewer">${message.data ? syntaxHighlight(jsonData) : 'Êó†Êï∞ÊçÆ'}</div>
                    `;
                }
                
                return `
                    <div class="message-item">
                        <div class="message-header">
                            <span class="message-id">#${message.id}</span>
                            <span class="message-timestamp">${message.timestamp}</span>
                            <span class="message-source">${message.source_ip}</span>
                        </div>
                        
                        ${message.error ? `
                            <div style="color: #e74c3c; font-weight: bold; margin-bottom: 0.5rem;">
                                ‚ùå ÈîôËØØ: ${message.error}
                            </div>
                        ` : ''}
                        
                        <div class="message-content">
                            ${contentHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØÔºàÊöÇÊó∂Âè™ËÆ∞ÂΩïÊó•ÂøóÔºâ
        function updatePagination(pagination) {
            console.log('ÂàÜÈ°µ‰ø°ÊÅØ:', pagination);
        }
        
        // Ëá™Âä®Âà∑Êñ∞ÂàáÊç¢
        function autoRefreshToggle() {
            const btn = document.getElementById('auto-refresh-btn');
            
            if (isAutoRefresh) {
                clearInterval(autoRefreshInterval);
                btn.textContent = '‚è±Ô∏è Ëá™Âä®Âà∑Êñ∞';
                btn.style.backgroundColor = '#667eea';
                isAutoRefresh = false;
            } else {
                autoRefreshInterval = setInterval(refreshMessages, 5000);
                btn.textContent = '‚èπÔ∏è ÂÅúÊ≠¢Âà∑Êñ∞';
                btn.style.backgroundColor = '#e74c3c';
                isAutoRefresh = true;
            }
        }
        
        // Ê∏ÖÁ©∫Ê∂àÊÅØ
        function clearMessages() {
            if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊ∂àÊÅØÂêóÔºü')) return;
            
            fetch('/api/clear_messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                location.reload();
            })
            .catch(error => {
                console.error('Ê∏ÖÁ©∫Â§±Ë¥•:', error);
                alert('Ê∏ÖÁ©∫Â§±Ë¥•: ' + error.message);
            });
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // ÂàùÂßãÂåñÂÆûÊó∂ËøûÊé•
            initRealTimeConnection();
            
            // ÂàùÂßãÊõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
            updateMessageStats();
            
            // Ëá™Âä®ÂêØÂä®Ëá™Âä®Âà∑Êñ∞ÔºàÈªòËÆ§ÂºÄÂêØÔºâ
            if (isAutoRefresh) {
                autoRefreshInterval = setInterval(refreshMessages, 5000);
                console.log('Ëá™Âä®Âà∑Êñ∞Â∑≤ÂêØÂä®');
            }
            
            // ÂΩíÊ°£ÂºÄÂÖ≥‰∫ã‰ª∂
            const archiveToggle = document.getElementById('include-archived');
            if (archiveToggle) {
                archiveToggle.addEventListener('change', function() {
                    includeArchived = this.checked;
                    currentPage = 1; // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
                    
                    // Êõ¥Êñ∞URL
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('page', '1');
                    if (includeArchived) {
                        newUrl.searchParams.set('archived', 'true');
                    } else {
                        newUrl.searchParams.delete('archived');
                    }
                    window.location.href = newUrl.toString();
                });
            }
            
            // ÂàùÂßãÂåñJSONÈ´ò‰∫Æ
            document.querySelectorAll('.json-viewer').forEach((element, index) => {
                const jsonData = element.getAttribute('data-json');
                const jsonContent = element.textContent || element.innerText;
                
                if (jsonData) {
                    // Â¶ÇÊûúÊúâdata-jsonÂ±ûÊÄßÔºå‰ΩøÁî®ËØ•Êï∞ÊçÆ
                    try {
                        const parsed = JSON.parse(jsonData);
                        const formatted = JSON.stringify(parsed, null, 2);
                        element.innerHTML = syntaxHighlight(formatted);
                    } catch (e) {
                        element.innerHTML = syntaxHighlight(jsonData);
                    }
                } else if (jsonContent && jsonContent.trim()) {
                    // Âê¶Âàô‰ΩøÁî®ÊñáÊú¨ÂÜÖÂÆπ
                    try {
                        const parsed = JSON.parse(jsonContent);
                        const formatted = JSON.stringify(parsed, null, 2);
                        element.innerHTML = syntaxHighlight(formatted);
                    } catch (e) {
                        // Â¶ÇÊûú‰∏çÊòØÊúâÊïàJSONÔºå‰øùÊåÅÂéüÊ†∑‰ΩÜÂ∫îÁî®ËØ≠Ê≥ïÈ´ò‰∫Æ
                        element.innerHTML = syntaxHighlight(jsonContent);
                    }
                }
            });
        });
        
        // È°µÈù¢ÂÖ≥Èó≠Êó∂Ê∏ÖÁêÜËøûÊé•
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>